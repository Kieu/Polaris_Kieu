<% if @array_promotion.count > 0 %>
<% content_for :sidebar do %>
	<%= render partial: "layouts/sidebar", locals: {object: @array_promotion} %>
<% end %>
<%= stylesheet_link_tag "css/common" %>
<%= stylesheet_link_tag "css/promotions" %>
<%= stylesheet_link_tag "css/colorbox" %>

<%= stylesheet_link_tag "css/box_inner_promotion" %>
<ul class="contentNavi">
	<li class="pre"><a href="javascript:void(0)" onclick="ajaxCommon('/clients?client_id=<%=@client_id%>', '#<%= @client_id %>', '.client_name', '','#inner,#sidebar')"><%= @client_name %></a></li>
	<li>&gt;</li>
	<li><%= @promotion_name %></li>
</ul>

<div class="date">今日<br />
<div id="datepicker">
<%= Date.today.at_beginning_of_month.strftime("%Y/%m/%d").to_s %>~<%= Date.today.strftime("%Y/%m/%d").to_s %>&#9660;</div>
</div>
<div class="clear"></div>
<div id="graph">
	<ul class="btn_details" id="">
		<li> <a href="#"><img src="/assets/btn_use.gif" alt="" class="btn" width="120" height="35" /></a>
			<ul>
				<li> <a href="#">掲載結果</a>
					<ul>
						<li><a href="javascript:void(0)" class="metric_click_left">imp</a></li>
						<li><a href="javascript:void(0)" class="metric_click_left">click</a></li>
						<li><a href="javascript:void(0)" class="metric_click_left">CTR</a></li>
						<li><a href="javascript:void(0)" class="metric_click_left">COST</a></li>
						<li><a href="javascript:void(0)" class="metric_click_left">CPM</a></li>
						<li><a href="javascript:void(0)" class="metric_click_left">CPC</a></li>
					</ul>
				</li>
				<li><a href="#">成果</a>
					<ul>
						<li><a href="#">CV</a></li>
						<li><a href="#">CV(初回)</a></li>
						<li><a href="#">CV(リピート)</a></li>
						<li><a href="#">CVR</a></li>
						<li><a href="#">CPA</a></li>
						<li><a href="#">ASSIST</a> </li>
					</ul>
				</li>
			</ul>
		</li>
	</ul>
	<p> vs </p>
	<ul class="btn_details" id="">
		<li> <a href="#"><img src="/assets/btn_click.gif" alt="" class="btn" width="120" height="35" /></a>
			<ul>
				<li> <a href="#">掲載結果</a>
					<ul>
						<li><a href="javascript:void(0)" class="metric_click_right">imp</a></li>
						<li><a href="javascript:void(0)" class="metric_click_right">click</a></li>
						<li><a href="javascript:void(0)" class="metric_click_right">CTR</a></li>
						<li><a href="javascript:void(0)" class="metric_click_right">COST</a></li>
						<li><a href="javascript:void(0)" class="metric_click_right">CPM</a></li>
						<li><a href="javascript:void(0)" class="metric_click_right">CPC</a></li>
					</ul>
				</li>
				<li><a href="#">成果</a>
					<ul>
						<li><a href="#">CV</a></li>
						<li><a href="#">CV(初回)</a></li>
						<li><a href="#">CV(リピート)</a></li>
						<li><a href="#">CVR</a></li>
						<li><a href="#">CPA</a></li>
						<li><a href="#">ASSIST</a> </li>
					</ul>
				</li>
			</ul>
		</li>
	</ul>
	<div class="fl-r">
		<p><%= link_to image_tag("/assets/btn_dl_option.gif"), "javascript:void(0)", id: "show_option" %></p>
		<p><%= link_to image_tag("/assets/btn_dl_report.gif"), "javascript:void(0)", id: "download_csv" %></p>
	</div>
</div>
<div class="clear"></div>
<!--グラフ_JS-->
<div id="sample-chart" class="sample-chart" style="height: 300px; width: 1000px"></div>
<!--/グラフ_JS-->

<% if flash[:error] %>
    <div><%= flash[:error] %></div>
<% end %>
<p class="p-blue category_Dashboard">ダッシュボード</p>
<table width="100%" border="1" bordercolor="#b5b5b5" cellpadding="0" class="promotion_table" id="promotion_table">
<tr>
	<td rowspan="3" class="table_header">Media</td>
	<td rowspan="3" class="table_header">Account</td>
	<% Settings.promotions_options.each_with_index do |option, index|%>
		<%= content_tag(:td, option, rowspan: "3", class: "table_header") if cookies[:promotion][index] == "1" %>
	<% end %>
	<% @conversions.each do |conversion|%>
		<% colspan = cal_col_cv(conversion.id) %>
		<%= content_tag(:td, conversion.conversion_name, colspan: colspan, class: "table_header") if colspan > 0 %>
	<% end %>
</tr>
<tr>
	<% @conversions.each_with_index do |conversion, index|%>
		<% colspan = cal_cv(conversion.id) %>
		<%= content_tag(:td, "CV#{index}", colspan: colspan, class: "table_header") if colspan > 0 %>
		<% Settings.conversions_options.each_with_index do |option, index1|%>
			<% break if index1 == 7 %>
			<%= content_tag(:td, Settings.conversions_options[index1+3], rowspan: "2", class: "table_header") if colspan > 0 && cookies[("conversion" + conversion.id.to_s).to_sym][index1+3] == "1"%>
		<% end %>
	<% end %>
</tr>
<tr>
	<% @conversions.each do |conversion|%>
		<% colspan = cal_cv(conversion.id) %>
		<% Settings.conversions_options.each_with_index do |option, index1|%>
			<% break if index1 == 3 %>
			<%= content_tag(:td, Settings.conversions_options[index1], class: "table_header") if colspan > 0 && cookies[("conversion" + conversion.id.to_s).to_sym][index1] == "1"%>
		<% end %>
	<% end %>
</tr>
<tr>
	<td class="header_total"></td>
	<td class="header_total"></td>
	<% Settings.promotions_options.each_with_index do |option, index|%>
		<%= content_tag(:td, @promotion_results[option+"_total"], class: "header_total") if cookies[:promotion][index] == "1" %>
	<% end %>
	<% @conversions.each do |conversion|%>
		<% Settings.conversions_options.each_with_index do |option, index|%>
			<%= content_tag(:td, @conversions_results["conversion"+conversion.id.to_s+"_"+ option+"_total"], class: "header_total") if cookies[("conversion" + conversion.id.to_s).to_sym][index] == "1"%>
		<% end %>
	<% end %>
</tr>
<% Settings.media_category.each do |category| %>
	<tr>
    	<td class="category_header"><%= category[1] %></td>
		<td class="category_header">total</td>
		<% Settings.promotions_options.each_with_index do |option, index|%>
			<%= content_tag(:td, @promotion_results[category[1]+"_"+option+"_total"], class: "category_header") if cookies[:promotion][index] == "1" %>
		<% end %>
		<% @conversions.each do |conversion|%>
			<% Settings.conversions_options.each_with_index do |option, index|%>
				<%= content_tag(:td, @conversions_results[category[1]+"_conversion"+conversion.id.to_s+"_"+option], class: "category_header") if cookies[("conversion" + conversion.id.to_s).to_sym][index] == "1"%>
			<% end %>
		<% end %>
	</tr>
    <% Media.where(media_category_id: category[0].to_s).each_with_index do |media, index| %>
		<% break if index == "10" %>
		<% media.accounts.each_with_index do |account, index1| %>
		<tr>
			<%= content_tag(:td, media.media_name, rowspan: media.accounts.count) if index1 == 0 %>
            <td><%= account.account_name %></td>
            <% Settings.promotions_options.each_with_index do |option, index2|%>
				<%= content_tag(:td, @promotion_results[account.account_name+"_"+option]) if cookies[:promotion][index2] == "1" %>
			<% end %>
			<% @conversions.each do |conversion|%>
				<% Settings.conversions_options.each_with_index do |option, index2|%>
					<%= content_tag(:td, @conversions_results[account.account_name+"_conversion"+conversion.id.to_s+"_"+option]) if cookies[("conversion" + conversion.id.to_s).to_sym][index2] == "1"%>
				<% end %>
			<% end %>
        </tr>
        <% end %>
    <% end %>
<% end %>
</table>
<br/>
<br/>
<div id="popup" style="display: none">
	<div id="list_options">
		<div class="f_box">
			<p class="f_box_title">テーブル</p>
			<p class="f_category_title1">掲載結果</p>
			<p class="f_category_title2">成果</p>

			<div class="box01">
				<p class="box01_txt">全て追加する </p>
				<div class="check-group clearfix">
					<ul>
						<% Settings.promotions_options.each_with_index do |option, index|%>
							<li>
								<p class="check_txt"><%= option %></p>
								<div>
									<% if cookies[:promotion][index] == "1" %>
										<input type="checkbox" value="c1p" checked="checked" name="check" id="checbox<%= index+1 %>">
										<label for="checkbox<%= index+1 %>" class="checked" onclick="update_cookie_promotion('<%= index %>')">Check</label>
									<% else %>
										<input type="checkbox" value="c1" name="check" id="checbox<%= index+1 %>">
										<label for="checkbox<%= index+1 %>" class onclick="update_cookie_promotion('<%= index %>')">Check</label>
									<% end %>
								</div>
							</li>
						<% end %>
					</ul>
				</div>
			</div>
			<div class="box02">
				<ul id="tab">
					<% @conversions.each_with_index do |conversion, index| %>
						<% if index == 0%>
							<li class="present"><p class="f_arrow">CV<%=index +1 %><span class=><%= conversion.conversion_name%></span></p></li>
						<% else %>
							<li><p class="f_arrow">CV<%=index +1 %><span class=><%= conversion.conversion_name%></span></p></li>
						<% end %>
					<% end %>
				</ul>
				
			</div>
			
			<div class="box03">
				<% @conversions.each_with_index do |conversion,index| %>
					<div id="page<%= index+1 %>">
						<div class="check-group clearfix">
							<ul>
								<% Settings.conversions_options.each_with_index do |option, index1|%>
								<li>
									<p class="check_txt"><%= option %></p>
									<div>
										<% if cookies[('conversion' + conversion.id.to_s).to_sym][index1] == '0' %>
											<input type="checkbox" value="c1" name="check" id="checbox<%= index+1 %>">
											<label for="checkbox<%= index+1%>" onclick="update_cookie('<%= index1 %>','<%= conversion.id %>')">Check</label>
										<% else %>
											<input type="checkbox" value="c1" name="check" id="checbox<%= index+1 %>" checked="checked">
											<label for="checkbox<%= index+1%>" class="checked" onclick="update_cookie('<%= index1 %>','<%= conversion.id %>')">Check</label>
										<% end %>
									</div>
								</li>
								<% end %>
							</ul>
						</div>
					</div>
				<% end %>
			</div>
			<div class="submit_area_option">
				<p><a href="javascript:void(0)" id= "change_cookie"><img  alt="完成" src="/assets/btn_done.gif"></a></p>
				<p><a href="javascript:void(0)" id= "not_change_cookie"><img align="right" alt="キャンセル" src="/assets/btn_cancel.gif"></a></p>
			</div>
		</div>
  	</div>
</div>
<script type="text/javascript">
    $('#download_csv').click(function(){
        $.ajax({
            url: "<%= download_csv_promotions_path %>",
            data: {"promotion_id" : "<%= @promotion.id if @promotion %>"},
            method: "post",
            success: function(data){
            }

        })
    })

    $(function() {
        $("#show_option").click(function(){
            $.colorbox({
                width: "725",
                inline: true,
                escKey: false,
                overlayClose: false,
                href: "#list_options",
                height:"525"
            });
        })
        cookies_options = $.cookie("promotion");
        array_conversions = new Array();
        cookies_conversions = new Object();
        <% @conversions.each do |conversion| %>
	        cookies_conversions = {key: "<%= conversion.id %>", value: $.cookie("conversion<%= conversion.id %>")};
	        array_conversions.push(cookies_conversions);
        <% end %>
        console.log(array_conversions);
        update_cookie_promotion = function(data){
            options = cookies_options.split("");
            options[data] = (options[data] == "1") ? "0" : "1";
            options = options.join("");
            cookies_options = options;
        }
        update_cookie = function(data, pos){
            position = 0;
            for(var i=0;i<array_conversions.length;i++){
                if (parseInt(array_conversions[i].key) == pos){
                    options = array_conversions[i].value.split("");
                    position = i;
                    break;
                };
            }
            options[data] = (options[data] == "1") ? "0" : "1";
            options = options.join("");
            array_conversions[position].value = options;
        }
        $("#change_cookie").click(function(){
            $.cookie("promotion",cookies_options);
            <% @conversions.each do |conversion| %>
            $.cookie("conversion<%= conversion.id %>", array_conversions)
            array_conversions.push(cookies_conversions);
            for(var i=0;i<array_conversions.length;i++){
                if (array_conversions[i].key == "<%= conversion.id %>"){
                    $.cookie("conversion<%= conversion.id %>", array_conversions[i].value)
                    break;
                };
            }
            <% end %>
            //ajaxCommon("/promotions?client_id=<%= @client_id %>&promotion_id=<%= @promotion_id %>", "#<%= @promotion_id %>", ".promotion_name", "#promotion_name","#inner");
            //$('#list_options').colorbox.close();
            location.href = location.href;
        });
        $("#not_change_cookie").click(function(){
            cookies_options = $.cookie("promotion");
            $('#list_options').colorbox.close();
        })
		$(".btn_details").droppy();
		var tab = {
    		init: function(){
    			var tabs = this.setup.tabs;
    			var pages = this.setup.pages;
				for(i=0; i<pages.length; i++) {
					if(i !== 0) pages[i].style.display = 'none';
					tabs[i].onclick = function(){ tab.showpage(this); return false; };
    			}
    		},
			showpage: function(obj){
    			var tabs = this.setup.tabs;
    			var pages = this.setup.pages;
    			var num;
				for(num=0; num<tabs.length; num++) {
    				if(tabs[num] === obj) break;
    			}
				for(var i=0; i<pages.length; i++) {
					if(i == num) {
						pages[num].style.display = 'block';
						tabs[num].className = 'present';
					}
					else{
    					pages[i].style.display = 'none';
    					tabs[i].className = null;
    				}
    			}
    		}
    	}
    	$('div.check-group input').each(function(){
		if ($(this).attr('checked') == 'checked') {
			$(this).next().addClass('checked');

		}
	});
	//クリックした要素にクラス割り当てる
	$('div.check-group label').click(function(){
		
		if ($(this).prev('input').attr('checked')=="checked"){
			$(this)
				.removeClass('checked')
				.prev('input').removeAttr('checked');
		}else{
			$(this)
				.addClass('checked')
				.prev('input').attr('checked','checked');
		}
	});
	categories = [];
	data = new Object();
	<% Settings.promotions_options.each do |option| %>
		data["<%= option %>"] = [];
    	<% @promotion_data[option].each do |data| %>
			data["<%= option %>"].push(parseInt("<%= data%>"));
		<% end %>
	<% end %>
	/* Get data*/
	<% @array_category.each do |category|%>
		categories.push("<%= category %>");
	<% end %>

	left = "<%= @select_left %>";
	right = "<%= @select_right %>";
    draw_chart(data[left], data[right], left, right, categories)
    $(".metric_click_left").click(function(){
    	left = $(this).text();
    	draw_chart(data[left], data[right], left,right, categories)
    });
    $(".metric_click_right").click(function(){
    	right = $(this).text();
    	draw_chart(data[left], data[right], left,right, categories)
    });
    
    function formatDate(year, month, day){
		 if (year < 2000) { year = parseInt(year) + 1900; }
		 if (month.length == 1) { month = "0" + parseInt(month); }
		 if (day.length == 1) { day = "0" + parseInt(day); }
		 return year + month + day;
		}
    
    $('#datepicker').daterangepicker({
		lang: $('#lang').val(),
            onDone: function() {
                var term = $('#datepicker').val();
                
                var d = term.split(' - ');
                start_date = d[0].split("/");
                start_date = formatDate(start_date[0],start_date[1],start_date[2]);
                end_date = d[1].split("/");
                end_date = formatDate(end_date[0],end_date[1],end_date[2]);
                $.ajax({
                	url: "<%= promotions_path %>",
                	method: "GET",
                	dataType: "html",
                	data: "client_id=" + "<%= @client_id %>" + "&promotion_id=" + "<%= @promotion_id %>" + "&start_date=" + start_date + "&end_date=" + end_date,
                	success: function(data){
                		array_inner = "#sample-chart,#promotion_table";
                		array_inner = array_inner.split(",");
                		for (i=0;i<array_inner.length;i++){
	            		var inner_data = $(data).find(array_inner[i]);
	            		$(array_inner[i]).html(inner_data.children());
	            		}
	            		draw_chart(data[left], data[right], left, right, categories);
	            	}
				})
			}
        });
    

    });
</script>
<% else %>
  <b> No data</b>
<% end %>